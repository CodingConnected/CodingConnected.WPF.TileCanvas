<UserControl x:Class="CodingConnected.WPF.TileCanvas.Library.Controls.TilePanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:CodingConnected.WPF.TileCanvas.Library.Controls"
             x:Name="Root">
    <UserControl.Template>
        <ControlTemplate TargetType="local:TilePanel">
            <Grid>
                <Border BorderBrush="{TemplateBinding PaneBorderBrush}"
                        BorderThickness="{TemplateBinding PaneBorderThickness}"
                        Background="{TemplateBinding PaneBackgroundBrush}"
                        CornerRadius="6">
                <Border.Margin>
                    <Binding Path="PanelMargin" RelativeSource="{RelativeSource TemplatedParent}"/>
                </Border.Margin>
                <Border.Effect>
                    <DropShadowEffect BlurRadius="7" ShadowDepth="3" Opacity="0.3"/>
                </Border.Effect>

                <Grid ClipToBounds="True">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Header -->
                    <Border x:Name="PART_Header" Grid.Row="0" CornerRadius="6,6,0,0"
                            Background="{Binding HeaderBrush, ElementName=Root}"
                            BorderBrush="Gray" Visibility="{Binding HeaderVisibility, ElementName=Root}"
                            BorderThickness="0,0,0,1" Height="35"
                            Cursor="{Binding HeaderCursor, ElementName=Root}">
                        <Grid>
                            <!-- Title Container - Grid to overlay TextBox on TextBlock -->
                            <Grid Background="Transparent" Margin="5">
                                <!-- Title Display Mode -->
                                <TextBlock x:Name="PART_TitleDisplay"
                                        Text="{Binding Title, ElementName=Root}"
                                        FontWeight="Bold"
                                        FontSize="14" 
                                        VerticalAlignment="Center" HorizontalAlignment="Left"
                                        Cursor="IBeam">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Visibility" Value="Visible"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsEditingTitle, ElementName=Root}" Value="True">
                                                    <Setter Property="Visibility" Value="Hidden"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>

                                <!-- Title Edit Mode - Overlaid on same Grid cell -->
                                <TextBox x:Name="PART_TitleEditor"
                                    FontWeight="Bold"
                                    FontSize="14"
                                    VerticalAlignment="Center" HorizontalAlignment="Left"
                                    BorderThickness="1"
                                    BorderBrush="#FF0078D4"
                                    Background="White"
                                    Padding="2"
                                    MinWidth="80">
                                    <TextBox.Style>
                                        <Style TargetType="TextBox">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsEditingTitle, ElementName=Root}" Value="True">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBox.Style>
                                </TextBox>
                            </Grid>

                            <!-- Color Picker Button -->
                            <Button x:Name="PART_ColorButton"
                                   Content="ðŸŽ¨"
                                   Width="25" Height="25"
                                   HorizontalAlignment="Right"
                                   VerticalAlignment="Top"
                                   Margin="0,5,30,0"
                                   Background="Transparent"
                                   BorderThickness="0"
                                   FontWeight="Bold"
                                   Cursor="Hand"
                                   Visibility="{Binding CloseButtonVisibility, ElementName=Root}"/>

                            <!-- Close Button -->
                            <Button x:Name="PART_CloseButton"
                                   Content="âœ•"
                                   Width="25" Height="25"
                                   HorizontalAlignment="Right"
                                   VerticalAlignment="Top"
                                   Margin="0,5,5,0"
                                   Background="Transparent"
                                   BorderThickness="0"
                                   FontWeight="Bold"
                                   Cursor="Hand"
                                   Visibility="{Binding CloseButtonVisibility, ElementName=Root}"/>
                        </Grid>
                    </Border>

                    <!-- Content -->
                    <Border Grid.Row="1" Padding="0">
                        <Border.Margin>
                            <Binding Path="ContentMargin" RelativeSource="{RelativeSource TemplatedParent}"/>
                        </Border.Margin>
                        <ContentPresenter Content="{TemplateBinding Content}"/>
                    </Border>
                    
                    
                    <!-- Dragger when no Header -->
                    <Border x:Name="PART_DragElementNoHeader" Grid.Row="1" CornerRadius="6,0,3,0"
                        Background="LightGray" Opacity=".5"
                        BorderBrush="Gray" Visibility="{Binding DragElementNoHeaderVisibility, ElementName=Root}"
                        BorderThickness="0,0,1,1" Height="15" Width="15"
                        HorizontalAlignment="Left" VerticalAlignment="Top"
                        Cursor="{Binding HeaderCursor, ElementName=Root}">
                    </Border>
                    
                    <!-- Close Button when no header -->
                    <Button x:Name="PART_CloseButtonNoHeader"
                           Content="âœ•" Grid.Row="1"
                           Width="25" Height="25"
                           HorizontalAlignment="Right"
                           VerticalAlignment="Top"
                           Margin="0,5,5,0"
                           Background="Transparent"
                           BorderThickness="0"
                           FontWeight="Bold"
                           Cursor="Hand"
                           Visibility="{Binding CloseButtonNoHeaderVisibility, ElementName=Root}"/>

                    <!-- Resize Thumb -->
                    <Thumb x:Name="PART_ResizeThumb"
                           Grid.RowSpan="2"
                           Width="15" Height="15"
                           HorizontalAlignment="Right"
                           VerticalAlignment="Bottom"
                           Margin="0,0,3,3"
                           Cursor="SizeNWSE"
                           Background="DarkGray"
                           Opacity="0.5"
                           Visibility="{Binding ResizeThumbVisibility, ElementName=Root}">
                        <Thumb.Template>
                            <ControlTemplate TargetType="Thumb">
                                <Grid>
                                    <Path Fill="DarkGray" StrokeThickness="0" Opacity="0.5"
                  Data="M0,15 L15,15 L15,0 Z"/>
                                </Grid>
                            </ControlTemplate>
                        </Thumb.Template>
                    </Thumb>
                </Grid>
                </Border>
            
                <!-- Color Picker Popup -->
                <Popup x:Name="PART_ColorPopup"
                       PlacementTarget="{Binding ElementName=PART_ColorButton}"
                       Placement="Bottom"
                       HorizontalOffset="-100"
                       StaysOpen="False"
                       AllowsTransparency="True">
                    <Border Background="White" 
                            BorderBrush="Gray" 
                            BorderThickness="1" 
                            CornerRadius="3"
                            Padding="5">
                        <Border.Effect>
                            <DropShadowEffect BlurRadius="8" ShadowDepth="2" Opacity="0.3"/>
                        </Border.Effect>
                        
                        <ScrollViewer VerticalScrollBarVisibility="Auto" 
                                      HorizontalScrollBarVisibility="Disabled"
                                      MaxHeight="200">
                            <UniformGrid x:Name="PART_ColorGrid" 
                                         Columns="5" 
                                         Margin="2"/>
                        </ScrollViewer>
                    </Border>
                </Popup>
            </Grid>
        </ControlTemplate>
    </UserControl.Template>
</UserControl>
